from aiogram import Router, F
from aiogram.filters import Command, CommandStart
from aiogram.types import Message, CallbackQuery
from sqlalchemy.ext.asyncio import AsyncSession

from database.models import User
from keyboards.kb import get_main_keyboard
from services.user_service import UserService


# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—â–∏—Ö –∫–æ–º–∞–Ω–¥
router = Router()


@router.message(CommandStart())
async def cmd_start(message: Message, session: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_service = UserService(session)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –µ—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º
    user = await user_service.get_user_by_tg_id(message.from_user.id)
    if not user:
        user = await user_service.create_user(
            tg_id=message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name,
            last_name=message.from_user.last_name,
        )
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await message.answer(
        f"üöÄ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ TaskHero, {user.first_name}!</b>\n\n"
        "–Ø —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç —Ä—É—Ç–∏–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ! ‚ú®\n\n"
        "üéÆ <b>TaskHero - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫:</b>\n"
        "‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π –∑–∞–¥–∞—á–∏ –∏ –ø–æ–ª—É—á–∞–π –æ–ø—ã—Ç –∑–∞ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ\n"
        "‚Ä¢ –ü–æ–≤—ã—à–∞–π —Å–≤–æ–π —É—Ä–æ–≤–µ–Ω—å –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è\n"
        "‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç–∞–Ω–æ–≤–∏—Å—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–µ–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å\n\n"
        "üéØ –ì–æ—Ç–æ–≤ —Å—Ç–∞—Ç—å –≥–µ—Ä–æ–µ–º —Å–≤–æ–µ–π –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏? –ù–∞–∂–º–∏ <b>\"‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É\"</b> –∏ –Ω–∞—á–Ω–∏ —Å–≤–æ–π –ø—É—Ç—å –∫ —É—Å–ø–µ—Ö—É!",
        parse_mode="HTML",
        reply_markup=get_main_keyboard()
    )


@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = (
        "ü¶∏‚Äç‚ôÇÔ∏è <b>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–µ—Ä–æ—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</b>\n\n"
        "üîç <b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        "‚Ä¢ /start ‚Äî –ù–∞—á–∞—Ç—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ\n"
        "‚Ä¢ /help ‚Äî –û—Ç–∫—Ä—ã—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–µ—Ä–æ—è\n"
        "‚Ä¢ /tasks ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞–º–∏\n"
        "‚Ä¢ /achievements ‚Äî –ö–Ω–∏–≥–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n"
        "‚Ä¢ /stats ‚Äî –ñ—É—Ä–Ω–∞–ª –≥–µ—Ä–æ—è\n\n"
        
        "üí° <b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è TaskHero:</b>\n"
        "1. –ù–∞–∂–º–∏ <b>‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</b> –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–≤–µ—Å—Ç–∞\n"
        "2. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π —Å–≤–æ–∏ –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ <b>üìù –ú–æ–∏ –∑–∞–¥–∞—á–∏</b>\n"
        "3. –í—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞—á–∏, –ø–æ–ª—É—á–∞–π –æ–ø—ã—Ç –∏ –æ—Ç–∫—Ä—ã–≤–∞–π –Ω–æ–≤—ã–µ —É—Ä–æ–≤–Ω–∏\n"
        "4. –°–ª–µ–¥–∏ –∑–∞ —Å–≤–æ–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –≤ —Ä–∞–∑–¥–µ–ª–µ <b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>\n\n"
        
        "üèÜ <b>–°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:</b>\n"
        "‚Ä¢ –ö–∞–∂–¥–∞—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç —Ç–µ–±—è –∫ –Ω–æ–≤—ã–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º\n"
        "‚Ä¢ –ó–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å –±–æ–Ω—É—Å–Ω—ã–π –æ–ø—ã—Ç\n"
        "‚Ä¢ –†–∞–∑–±–ª–æ–∫–∏—Ä—É–π –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–º –≥–µ—Ä–æ–µ–º –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏!\n\n"
        
        "–£–¥–∞—á–Ω—ã—Ö –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π –≤ –º–∏—Ä–µ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏! üåü"
    )
    
    await message.answer(help_text, parse_mode="HTML", reply_markup=get_main_keyboard())


# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–º–æ—â—å"
@router.message(F.text == "‚ÑπÔ∏è –ü–æ–º–æ—â—å")
async def show_help_button(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '‚ÑπÔ∏è –ü–æ–º–æ—â—å'"""
    # –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
    await cmd_help(message)


@router.callback_query(F.data == "cancel")
async def cancel_action(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è"""
    await callback.message.delete()
    await callback.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ") 